@using ProjectBank.Core
@using ProjectBank.Client.Extensions
@inject HttpClient _http;
<a href="#" class="list-group-item list-group-item-action py-3 lh-tight @_extraCSS" aria-current="true">
    <div class="d-flex w-100 align-items-center justify-content-between">
        <strong class="mb-1">@Recipient</strong>
        <small>@_lastMessageDateString</small>
    </div>
    <div class="col-10 mb-1 small">@_relatedPostString.</div>
</a>

@code {

    private string? Recipient { get; set; }

    private string _lastMessageDateString { get; set; }

    [Parameter]
    public ChatDetailsDto Chat { get; set; }

    private string _relatedPostString { get; set; }

    [Parameter]
    public bool Read { get; set; }
    private string _extraCSS { get; set; }

    protected override void OnInitialized()
    {
        //Convert related posts to string
        _extraCSS = Read ? "" : "unread";
    }

    protected override async Task OnInitializedAsync()
    {
        
        var targetUser = Chat.LatestChatMessage.FromUser;
        Recipient = targetUser.Name;
        var relatedPost = await _http.GetFromJsonAsync<PostDetailsDto>($"/api/Post/{Chat.ProjectId}");
        if (relatedPost?.Title != null) _relatedPostString = relatedPost.Title;
        
        _lastMessageDateString = Chat.LatestChatMessage.Timestamp.GetTimeSince();
        
    }

}
